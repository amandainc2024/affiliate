<!DOCTYPE html>
<html>

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title></title>
 <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0/dist/apexcharts.min.js"></script>
 <script src="../browser.js" type="text/javascript" charset="utf-8"></script>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


</head>

<body class="box-border text-blue-900 px-2 bg-gray-100 py-15">
  
    <div id="cv" class="backdrop-blur loading flex flex-col justify-center items-center bg-[rgb(0,0,0,0.6)] fixed inset-0 z-5">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffffff" class="size-20 animate-spin">
      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
    </svg>
    <b id="cover_m" class="text-center font-normal text-white">Loading </b>
    
  </div>
  
  <nav class="fixed flex items-center w-full h-14 top-0 bg-white py-3 box-border left-0">
   <img src="../logo.png"  class="ml-3 h-full" alt="">
   <h2 class="ml-1.5 ">SupaAdmin Dashboard</h2>
   
  </nav>
  
  <section class="bg-white my-3 text-sm shadow-sm p-4 rounded-sm w-full">
   <h1 class="text-xl font-bold">Administrator</h1>
   <div class="flex w-full gap-2 justify-evenly items-center">
    <div class="py-3 text-sm mt-3 px-7 text-white text-center rounded-sm bg-blue-600 w-1/2">
      <h3 class="text-[8px] font-light w-full">USERS</h3>
      <h2 class="text-3xl font-bold"></h2>
    </div>
    <div class="py-3 mt-3 px-7 text-white text-center rounded-sm bg-blue-900 w-1/2">
      <h3 class="text-[8px] font-light w-full">PAYOUTS</h3>
      <h2 class="text-3xl font-bold" ></h2>
    </div>
   </div>
   <p class="text-center mt-3"><a href="">Withdraw Requests (3)</a></p>
  </section>
  
  
  <section class="mt-3 bg-white text-sm shadow-sm p-4 rounded-sm w-full">
    <h2 class="text-blue-900 font-bold mb-3">Users</h2>
    <div class="inline-block">
     <p class="mb-[-5px] text-xs opacity-75">Signed up</p>
     <b class="text-3xl"></b>
    </div>
    <div class="inline-block mx-3">
     <p class="mb-[-5px] text-xs opacity-90">Signed up today</p>
     <b id="st" class="text-3xl"></b>
    </div>
    
    
<div class="max-w-sm w-full bg-white rounded-lg shadow-sm bg-gray-800 p-4 md:p-6">
  <div class="flex justify-between">
    <div>
      <h5 class="leading-none text-3xl font-bold text-green-600 opacity-70" id="st2"></h5>
      <p class="text-sm font-normal text-gray-500 text-gray-400">Sign ups Today</p>
    </div>
    <div id="stp"
      class="flex items-center px-2.5 py-0.5 text-base font-semibold text-green-500 text-green-500 text-center">
      
      <svg class="w-3 h-3 ms-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 14">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13V1m0 0L1 5m4-4 4 4"/>
      </svg>
    </div>
  </div>
  <div id="area-chart1"></div>
  </div>
  </section>
    <section class="mt-3 bg-white text-sm shadow-sm p-4 rounded-sm w-full">
    <h2 class="text-blue-900 font-bold mb-3">Link Activity</h2>
    <div class="inline-block">
     <p class="mb-[-5px] text-xs opacity-75">Visits</p>
     <b class="text-3xl" id="visitsla"></b>
    </div>
    <div class="inline-block mx-3">
     <p class="mb-[-5px] text-xs opacity-90">Orders</p>
     <b class="text-3xl" id="ordersla"></b>
    </div>
    
  
  </section>

    <section class="overflow-scroll mt-3 bg-white text-sm shadow-sm h-auto p-4 rounded-sm w-full">
      <h1 class="text-blue-900 font-bold mb-3">Users info</h1>
      <table>
        <thead>
          <th class="w-47 text-sm font-normal text-gray-500">id</th>
          <th class="w-47 text-sm font-normal text-gray-500">Name</th>
          <th class="w-47 text-sm font-normal text-gray-500">Strategy</th>
          <th class="w-47 text-sm font-normal text-gray-500">Strategy Specifications</th>
          <th class="w-47 text-sm font-normal text-gray-500">Link</th>
          <th class="w-47 text-sm font-normal text-gray-500">Visits</th>
          <th class="w-47 text-sm font-normal text-gray-500">Orders</th>
          <th class="w-47 text-sm font-normal text-gray-500">Balance</th>
          
        </thead>
        <tbody>
       
        </tbody>
      </table>
      
      <style>
        table,tr,th,thead,td{
          border: solid 1px grey;
          border-collapse: collapse;
        }
        table{
          width:300%;
        }
        td{
          padding: 12px;
          width:1000px;
        }
        table ul{
          list-style: square;
          margin-left:22px;
        }
      </style>
    </section>
    <script src="dashboard.js"></script>
<script type="module">
  const supabaseUrl = "https://dlittddujwtdceassnwh.supabase.co";
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsaXR0ZGR1and0ZGNlYXNzbndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwMjUwMzksImV4cCI6MjA2MTYwMTAzOX0.Ro-mvdFQr1FDh219EPuI2Fm2S3yYXeTBwiO9UxIFv0s'; // Replace with your public anon key
  
  const client = window.supabase.createClient(supabaseUrl, supabaseKey);


  async function loadStats() {
    // Total users
    const { count: totalUsers } = await client
      .from('users')
      .select('*', { count: 'exact', head: true });
    document.querySelectorAll('h2.font-bold')[0].textContent = totalUsers ?? 0;
    document.querySelector('b.text-3xl').textContent = totalUsers ?? 0;

    // Signups today
    const today = new Date().toISOString().split('T')[0];
    const { count: signupsToday } = await client
      .from('users')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', today);
    document.querySelectorAll('#st')[0].textContent = `${signupsToday ?? 0}`;
    document.querySelectorAll('#st2')[0].textContent = `${signupsToday ?? 0}`;
    document.querySelectorAll('h5.text-green-600')[0].textContent = signupsToday ?? 0;
    document.querySelectorAll('#stp')[0].innerHTML = signupsToday/totalUsers+'%<svg class="w-3 h-3 ms-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 14">        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13V1m0 0L1 5m4-4 4 4"/> </svg>';
    console.log(signupsToday/totalUsers+'%')
    // Payouts
    const { data: payouts } = await client.from('users').select('balance');
    const totalPayouts = payouts?.reduce((sum, p) => sum + Number(p.balance), 0) ?? 0;
    document.querySelectorAll('h2.font-bold')[1].textContent = `$${totalPayouts.toFixed(1)}`;
  }
  
  async function loadUsersTable() {
  const { data: users } = await client.from('users').select('*');
  const { data: allOrders } = await client.from('orders').select('ref_id, orders');
  document.getElementById('visitsla').innerHTML = allOrders.length;
  document.getElementById('ordersla').innerHTML = allOrders.filter(o => o.orders === 'true').length;

  const tbody = document.querySelector('tbody');
  tbody.innerHTML = ''; // Clear existing

  users.forEach((u, i) => {
    const strategyList = (u.strategy || '').split(',').map(s => `<li>${s.trim()}</li>`).join('');
    
    const userOrders = allOrders.filter(o => o.ref_id === u.ref_id);
    const visits = userOrders.filter(o => o.orders).length;
    const orders = userOrders.filter(o => o.orders === "true").length;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${u.name}</td>
      <td><ul>${strategyList}</ul></td>
      <td>${u.specification || ''}</td>
      <td>${u.ref_id || ''}</td>
      <td>${visits}</td>
      <td>${orders}</td>
      <td>$${u.balance ?? 0}</td>
      
    `;
    tbody.appendChild(tr);
  });
}


  const { data: sessionData } = await client.auth.getSession();
  if (!sessionData.session) {
    location.href = '/auth.html';
  } else {
    const uid = sessionData.session.user.id;
    const { data: userData, error: userError } = await client.from('users').select('*').eq('uid', uid).single();
    if (!userData || userData.type !== 'admin') {
      location.href = '/auth.html';
      console.log(userData)
    } else {
      document.getElementById('cv').style.display = 'none';
      loadStats();
      loadUsersTable();
    }
  }

  window.lo = async () => {
    await supabase.auth.signOut();
    location.href = '/auth.html';
  };
  
  async function drawSignUpsChart() {
  const { data: users } = await client.from('users').select('created_at');
  
  const counts = {};
  let minDate = new Date(),
    maxDate = new Date(0);
  
  users.forEach(user => {
    const date = new Date(user.created_at).toISOString().split('T')[0];
    counts[date] = (counts[date] || 0) + 1;
    
    const d = new Date(date);
    if (d < minDate) minDate = d;
    if (d > maxDate) maxDate = d;
  });
  
  // Fill in missing dates with 0s
  const allDates = [];
  const current = new Date(minDate);
  while (current <= maxDate) {
    const key = current.toISOString().split('T')[0];
    allDates.push(key);
    if (!counts[key]) counts[key] = 0;
    current.setDate(current.getDate() + 1);
  }
  
  const seriesData = allDates.map(date => counts[date]);
  
  const options = {
    chart: { type: 'area', height: 250 },
    series: [{ name: 'Sign Ups', data: seriesData }],
    xaxis: {
      categories: allDates,
      type: 'category',
      title: { text: 'Date' }
    },
    yaxis: {
      title: { text: 'Number of Sign Ups' }
    },
    dataLabels: { enabled: false },
    stroke: { curve: 'smooth' }
  };
  
  const chart = new ApexCharts(document.querySelector("#area-chart1"), options);
  chart.render();
}

drawSignUpsChart();
</script>

</body>

</html>